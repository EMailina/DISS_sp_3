/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package diss_sp_3;

import OSPABA.IAnimDelegate;
import OSPABA.ISimDelegate;
import OSPABA.MessageForm;
import OSPABA.SimState;
import OSPABA.Simulation;
import OSPAnimator.IAnimator;
import OSPAnimator.ShapeAnimObject;
import OSPDataStruct.SimQueue;
import animation.Animator;
import java.awt.BasicStroke;
import java.awt.BorderLayout;
import java.awt.Color;
import java.awt.Dimension;
import java.awt.Graphics;
import java.awt.Graphics2D;
import java.awt.Image;

import java.io.File;
import java.io.IOException;
import static java.lang.Thread.sleep;
import java.util.logging.Level;
import java.util.logging.Logger;

import java.util.ArrayList;
import java.util.Queue;
import java.util.Timer;
import java.util.concurrent.ConcurrentLinkedQueue;
import javax.imageio.ImageIO;
import javax.swing.JFrame;
import javax.swing.JLabel;
import javax.swing.JPanel;
import javax.swing.JScrollPane;
import javax.swing.JTable;
import javax.swing.table.DefaultTableCellRenderer;
import javax.swing.table.DefaultTableModel;
import objects.CustomerObject;
import org.jfree.chart.ChartFactory;
import org.jfree.chart.ChartPanel;
import org.jfree.chart.JFreeChart;
import org.jfree.chart.axis.NumberAxis;
import org.jfree.chart.plot.PlotOrientation;
import org.jfree.chart.plot.XYPlot;
import org.jfree.data.xy.XYDataset;
import org.jfree.data.xy.XYSeries;
import org.jfree.data.xy.XYSeriesCollection;
import simulation.MyMessage;
import simulation.MySimulation;
import threads.ChartThread;
import threads.ExtraThread;

/**
 *
 * @author Erik
 */
public class Diss_sp_3 extends javax.swing.JFrame implements ISimDelegate {

    //  private XYSeries series = new XYSeries("Average waiting time");
    //  private JFreeChart chart1 = null;
    //  private XYSeriesCollection database1 = new XYSeriesCollection();
    //  private ChartPanel chartPanel1 = null;
    private XYSeries series = new XYSeries("Graph ");
    private JFreeChart chart = null;
    private XYSeriesCollection database = new XYSeriesCollection();
    private ChartPanel chartPanel = null;
    ExtraThread threadLogic;
    ChartThread threadGraph;
    Animator animator = null;
    private RunType runType;
    private boolean refreshGuiChanges = false;
//    MonteCarloBase base;
    private MySimulation simulation = null;
    private ManagerDependencies managerDep;
    private final String FREE = "FREE";
    private final String PAUSE = "PAUSE";
    private final String DASH = "-";
    ArrayList<Double> values = new ArrayList<>();
    private int offset = 0;
    Image img = null;
    int x = 0, y = 0;

    public Diss_sp_3() {

        initComponents();
        panelGraph2.setVisible(false);
        cleanLabels();

    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        StartButton = new javax.swing.JButton();
        EditCountOfReplications = new javax.swing.JTextField();
        StopButton = new javax.swing.JButton();
        jLabel1 = new javax.swing.JLabel();
        pauseButton = new javax.swing.JButton();
        speedSlider = new javax.swing.JSlider();
        SpeedLabel = new javax.swing.JLabel();
        startSimulation = new javax.swing.JButton();
        countOfEmployees2Box = new javax.swing.JTextField();
        countOfEmployees1Box = new javax.swing.JTextField();
        jLabel4 = new javax.swing.JLabel();
        jLabel5 = new javax.swing.JLabel();
        jLabel2 = new javax.swing.JLabel();
        jLabelTime = new javax.swing.JLabel();
        jLabelCountOfType1Employees = new javax.swing.JLabel();
        jLabelCountOfType2Employees = new javax.swing.JLabel();
        jLabelCountOfParkingPlaces = new javax.swing.JLabel();
        jLabelActualQueue = new javax.swing.JLabel();
        jLabelParking = new javax.swing.JLabel();
        jLabel3 = new javax.swing.JLabel();
        jLabel6 = new javax.swing.JLabel();
        jLabel7 = new javax.swing.JLabel();
        jLabel9 = new javax.swing.JLabel();
        jLabel11 = new javax.swing.JLabel();
        jLabel8 = new javax.swing.JLabel();
        jLabelCountReplication = new javax.swing.JLabel();
        jLabel12 = new javax.swing.JLabel();
        jLabel13 = new javax.swing.JLabel();
        jLabel14 = new javax.swing.JLabel();
        jLabel15 = new javax.swing.JLabel();
        jLabel16 = new javax.swing.JLabel();
        jLabel17 = new javax.swing.JLabel();
        jLabel18 = new javax.swing.JLabel();
        countOfEmployees2Box1 = new javax.swing.JTextField();
        countOfEmployees1Box1 = new javax.swing.JTextField();
        jLabel23 = new javax.swing.JLabel();
        jLabel24 = new javax.swing.JLabel();
        startSimulation2 = new javax.swing.JButton();
        startSimulation3 = new javax.swing.JButton();
        jPanel1 = new javax.swing.JPanel();
        jScrollPane4 = new javax.swing.JScrollPane();
        jTable4 = new javax.swing.JTable();
        jScrollPane3 = new javax.swing.JScrollPane();
        jTable3 = new javax.swing.JTable();
        jScrollPane1 = new javax.swing.JScrollPane();
        jTable1 = new javax.swing.JTable();
        jScrollPane2 = new javax.swing.JScrollPane();
        jTable2 = new javax.swing.JTable();
        jLabel20 = new javax.swing.JLabel();
        jLabel22 = new javax.swing.JLabel();
        jLabel21 = new javax.swing.JLabel();
        jLabel19 = new javax.swing.JLabel();
        jLabel10 = new javax.swing.JLabel();
        checkboxAnimation = new javax.swing.JCheckBox();
        countOfEmployees2Box2 = new javax.swing.JTextField();
        jLabel25 = new javax.swing.JLabel();
        countOfEmployees2Box3 = new javax.swing.JTextField();
        jLabel26 = new javax.swing.JLabel();
        jLabel27 = new javax.swing.JLabel();
        checkboxValidation = new javax.swing.JCheckBox();
        panelGraph2 = new javax.swing.JPanel();

        setDefaultCloseOperation(javax.swing.WindowConstants.EXIT_ON_CLOSE);
        setMaximumSize(new java.awt.Dimension(1300, 700));
        setMinimumSize(new java.awt.Dimension(1300, 700));
        setPreferredSize(new java.awt.Dimension(1200, 700));
        setSize(new java.awt.Dimension(1200, 700));
        getContentPane().setLayout(null);

        StartButton.setText("Start replications");
        StartButton.setName("startButton"); // NOI18N
        StartButton.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                StartButtonActionPerformed(evt);
            }
        });
        getContentPane().add(StartButton);
        StartButton.setBounds(290, 60, 150, 32);

        EditCountOfReplications.setText("1");
        EditCountOfReplications.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                EditCountOfReplicationsActionPerformed(evt);
            }
        });
        getContentPane().add(EditCountOfReplications);
        EditCountOfReplications.setBounds(147, 27, 121, 30);

        StopButton.setText("Stop");
        StopButton.setName("startButton"); // NOI18N
        StopButton.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                StopButtonActionPerformed(evt);
            }
        });
        getContentPane().add(StopButton);
        StopButton.setBounds(630, 20, 140, 32);

        jLabel1.setText("Count of replications");
        getContentPane().add(jLabel1);
        jLabel1.setBounds(17, 33, 117, 16);

        pauseButton.setText("Pause / Continue");
        pauseButton.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                pauseButtonActionPerformed(evt);
            }
        });
        getContentPane().add(pauseButton);
        pauseButton.setBounds(630, 60, 140, 32);

        speedSlider.setMaximum(5);
        speedSlider.setMinimum(1);
        speedSlider.setValue(3);
        speedSlider.addChangeListener(new javax.swing.event.ChangeListener() {
            public void stateChanged(javax.swing.event.ChangeEvent evt) {
                speedSliderStateChanged(evt);
            }
        });
        getContentPane().add(speedSlider);
        speedSlider.setBounds(450, 60, 170, 16);

        SpeedLabel.setText("Simulation speed: 3");
        getContentPane().add(SpeedLabel);
        SpeedLabel.setBounds(480, 30, 111, 16);

        startSimulation.setText("Start one Simulation");
        startSimulation.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                startSimulationActionPerformed(evt);
            }
        });
        getContentPane().add(startSimulation);
        startSimulation.setBounds(290, 20, 150, 32);

        countOfEmployees2Box.setText("17");
        getContentPane().add(countOfEmployees2Box);
        countOfEmployees2Box.setBounds(110, 110, 50, 30);

        countOfEmployees1Box.setText("4");
        countOfEmployees1Box.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                countOfEmployees1BoxActionPerformed(evt);
            }
        });
        getContentPane().add(countOfEmployees1Box);
        countOfEmployees1Box.setBounds(110, 70, 50, 30);

        jLabel4.setText("Employees 1:");
        getContentPane().add(jLabel4);
        jLabel4.setBounds(10, 80, 75, 16);

        jLabel5.setText("Cert 2:");
        getContentPane().add(jLabel5);
        jLabel5.setBounds(950, 40, 50, 16);

        jLabel2.setText("loading...");
        getContentPane().add(jLabel2);
        jLabel2.setBounds(30, 370, 480, 16);

        jLabelTime.setText("Time:");
        jLabelTime.setToolTipText("");
        getContentPane().add(jLabelTime);
        jLabelTime.setBounds(30, 190, 236, 16);

        jLabelCountOfType1Employees.setText("loading...");
        getContentPane().add(jLabelCountOfType1Employees);
        jLabelCountOfType1Employees.setBounds(30, 220, 236, 16);

        jLabelCountOfType2Employees.setText("loading...");
        getContentPane().add(jLabelCountOfType2Employees);
        jLabelCountOfType2Employees.setBounds(30, 250, 330, 16);

        jLabelCountOfParkingPlaces.setText("loading...");
        getContentPane().add(jLabelCountOfParkingPlaces);
        jLabelCountOfParkingPlaces.setBounds(30, 280, 236, 16);

        jLabelActualQueue.setText("loading...");
        getContentPane().add(jLabelActualQueue);
        jLabelActualQueue.setBounds(30, 310, 236, 16);

        jLabelParking.setText("loading...");
        getContentPane().add(jLabelParking);
        jLabelParking.setBounds(30, 340, 236, 16);

        jLabel3.setText("loading...");
        getContentPane().add(jLabel3);
        jLabel3.setBounds(30, 400, 480, 16);

        jLabel6.setText("loading...");
        getContentPane().add(jLabel6);
        jLabel6.setBounds(30, 430, 500, 16);

        jLabel7.setText("loading...");
        getContentPane().add(jLabel7);
        jLabel7.setBounds(30, 460, 530, 16);

        jLabel9.setText("loading...");
        getContentPane().add(jLabel9);
        jLabel9.setBounds(30, 520, 540, 16);

        jLabel11.setFont(new java.awt.Font("Dialog", 1, 18)); // NOI18N
        jLabel11.setText("Simulation");
        getContentPane().add(jLabel11);
        jLabel11.setBounds(20, 150, 220, 24);

        jLabel8.setText("loading...");
        getContentPane().add(jLabel8);
        jLabel8.setBounds(30, 250, 330, 16);

        jLabelCountReplication.setText("Time:");
        jLabelCountReplication.setToolTipText("");
        getContentPane().add(jLabelCountReplication);
        jLabelCountReplication.setBounds(30, 190, 214, 16);

        jLabel12.setText("loading...");
        getContentPane().add(jLabel12);
        jLabel12.setBounds(30, 220, 320, 16);

        jLabel13.setText("loading...");
        getContentPane().add(jLabel13);
        jLabel13.setBounds(30, 310, 330, 16);

        jLabel14.setText("loading...");
        getContentPane().add(jLabel14);
        jLabel14.setBounds(30, 280, 330, 16);

        jLabel15.setText("loading...");
        getContentPane().add(jLabel15);
        jLabel15.setBounds(30, 370, 570, 16);

        jLabel16.setText("loading...");
        getContentPane().add(jLabel16);
        jLabel16.setBounds(30, 400, 520, 16);

        jLabel17.setText("loading...");
        getContentPane().add(jLabel17);
        jLabel17.setBounds(30, 430, 580, 16);

        jLabel18.setText("loading...");
        getContentPane().add(jLabel18);
        jLabel18.setBounds(30, 340, 520, 16);

        countOfEmployees2Box1.setText("2");
        getContentPane().add(countOfEmployees2Box1);
        countOfEmployees2Box1.setBounds(880, 60, 50, 30);

        countOfEmployees1Box1.setText("2");
        getContentPane().add(countOfEmployees1Box1);
        countOfEmployees1Box1.setBounds(880, 20, 50, 30);

        jLabel23.setText("Employees 1:");
        getContentPane().add(jLabel23);
        jLabel23.setBounds(790, 30, 75, 16);

        jLabel24.setText("Employees 2:");
        getContentPane().add(jLabel24);
        jLabel24.setBounds(790, 70, 75, 16);

        startSimulation2.setText("Dependency on grp 2");
        startSimulation2.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                startSimulation2ActionPerformed(evt);
            }
        });
        getContentPane().add(startSimulation2);
        startSimulation2.setBounds(1020, 60, 160, 32);

        startSimulation3.setText("Dependency on grp 1");
        startSimulation3.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                startSimulation3ActionPerformed(evt);
            }
        });
        getContentPane().add(startSimulation3);
        startSimulation3.setBounds(1020, 20, 160, 32);

        jPanel1.setLayout(null);

        jTable4.setModel(new javax.swing.table.DefaultTableModel(
            new Object [][] {

            },
            new String [] {
                "No", "Customer", "Type"
            }
        ) {
            Class[] types = new Class [] {
                java.lang.String.class, java.lang.String.class, java.lang.String.class
            };

            public Class getColumnClass(int columnIndex) {
                return types [columnIndex];
            }
        });
        jTable4.setEnabled(false);
        jTable4.setPreferredSize(new java.awt.Dimension(300, 100));
        jTable4.getTableHeader().setReorderingAllowed(false);
        jScrollPane4.setViewportView(jTable4);
        if (jTable4.getColumnModel().getColumnCount() > 0) {
            jTable4.getColumnModel().getColumn(2).setMinWidth(150);
            jTable4.getColumnModel().getColumn(2).setMaxWidth(250);
        }

        jPanel1.add(jScrollPane4);
        jScrollPane4.setBounds(20, 40, 380, 210);

        jScrollPane3.setVerticalScrollBarPolicy(javax.swing.ScrollPaneConstants.VERTICAL_SCROLLBAR_NEVER);
        jScrollPane3.setPreferredSize(new java.awt.Dimension(250, 100));
        jScrollPane3.setRequestFocusEnabled(false);

        jTable3.setModel(new javax.swing.table.DefaultTableModel(
            new Object [][] {

            },
            new String [] {
                "Place", "Customer", "Vehicle"
            }
        ) {
            Class[] types = new Class [] {
                java.lang.String.class, java.lang.String.class, java.lang.String.class
            };

            public Class getColumnClass(int columnIndex) {
                return types [columnIndex];
            }
        });
        jTable3.setEnabled(false);
        jTable3.setMinimumSize(new java.awt.Dimension(225, 100));
        jTable3.setPreferredSize(new java.awt.Dimension(225, 100));
        jScrollPane3.setViewportView(jTable3);

        jPanel1.add(jScrollPane3);
        jScrollPane3.setBounds(430, 40, 370, 110);

        jTable1.setModel(new javax.swing.table.DefaultTableModel(
            new Object [][] {

            },
            new String [] {
                "Employer", "Customer", "Vehicle"
            }
        ) {
            Class[] types = new Class [] {
                java.lang.String.class, java.lang.String.class, java.lang.String.class
            };

            public Class getColumnClass(int columnIndex) {
                return types [columnIndex];
            }
        });
        jTable1.setEnabled(false);
        jScrollPane1.setViewportView(jTable1);

        jPanel1.add(jScrollPane1);
        jScrollPane1.setBounds(430, 190, 370, 270);

        jTable2.setModel(new javax.swing.table.DefaultTableModel(
            new Object [][] {

            },
            new String [] {
                "Employer", "Customer", "Type"
            }
        ) {
            Class[] types = new Class [] {
                java.lang.String.class, java.lang.String.class, java.lang.String.class
            };

            public Class getColumnClass(int columnIndex) {
                return types [columnIndex];
            }
        });
        jTable2.setEnabled(false);
        jTable2.getTableHeader().setReorderingAllowed(false);
        jScrollPane2.setViewportView(jTable2);
        if (jTable2.getColumnModel().getColumnCount() > 0) {
            jTable2.getColumnModel().getColumn(2).setMinWidth(150);
            jTable2.getColumnModel().getColumn(2).setMaxWidth(250);
        }

        jPanel1.add(jScrollPane2);
        jScrollPane2.setBounds(20, 300, 375, 160);

        jLabel20.setFont(new java.awt.Font("Dialog", 1, 14)); // NOI18N
        jLabel20.setText("Inspection (type 2)");
        jPanel1.add(jLabel20);
        jLabel20.setBounds(540, 160, 140, 19);

        jLabel22.setFont(new java.awt.Font("Dialog", 1, 14)); // NOI18N
        jLabel22.setText("Parking");
        jPanel1.add(jLabel22);
        jLabel22.setBounds(580, 10, 60, 19);

        jLabel21.setFont(new java.awt.Font("Dialog", 1, 14)); // NOI18N
        jLabel21.setText("Queue for take-over and payment");
        jPanel1.add(jLabel21);
        jLabel21.setBounds(90, 10, 236, 19);

        jLabel19.setFont(new java.awt.Font("Dialog", 1, 14)); // NOI18N
        jLabel19.setText("Take-over Vehicle (type 1)");
        jPanel1.add(jLabel19);
        jLabel19.setBounds(110, 260, 200, 19);

        getContentPane().add(jPanel1);
        jPanel1.setBounds(380, 150, 920, 530);

        jLabel10.setText("loading...");
        getContentPane().add(jLabel10);
        jLabel10.setBounds(30, 490, 540, 16);

        checkboxAnimation.setText("Animation");
        checkboxAnimation.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                checkboxAnimationActionPerformed(evt);
            }
        });
        getContentPane().add(checkboxAnimation);
        checkboxAnimation.setBounds(180, 90, 90, 20);

        countOfEmployees2Box2.setText("17");
        getContentPane().add(countOfEmployees2Box2);
        countOfEmployees2Box2.setBounds(260, 110, 50, 30);

        jLabel25.setText("Employees 2(all):");
        getContentPane().add(jLabel25);
        jLabel25.setBounds(10, 120, 110, 16);

        countOfEmployees2Box3.setText("2");
        getContentPane().add(countOfEmployees2Box3);
        countOfEmployees2Box3.setBounds(950, 60, 50, 30);

        jLabel26.setText("Certificate 2:");
        getContentPane().add(jLabel26);
        jLabel26.setBounds(180, 120, 72, 16);

        jLabel27.setText("loading...");
        getContentPane().add(jLabel27);
        jLabel27.setBounds(30, 550, 540, 16);

        checkboxValidation.setText("Validation");
        getContentPane().add(checkboxValidation);
        checkboxValidation.setBounds(180, 60, 90, 24);

        panelGraph2.setLayout(null);
        getContentPane().add(panelGraph2);
        panelGraph2.setBounds(27, 192, 1160, 420);

        pack();
    }// </editor-fold>//GEN-END:initComponents

    private void StartButtonActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_StartButtonActionPerformed
        runType = runType.REPLICATIONS;
        startThreads();
    }//GEN-LAST:event_StartButtonActionPerformed

    private void EditCountOfReplicationsActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_EditCountOfReplicationsActionPerformed

    }//GEN-LAST:event_EditCountOfReplicationsActionPerformed

    private void StopButtonActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_StopButtonActionPerformed
        // app.stopApplication();
        simulation.stopSimulation();
        if (simulation.getType() == RunType.DEPENDENCY_1 || simulation.getType() == RunType.DEPENDENCY_2) {
            managerDep.setStop(true);
        }

    }//GEN-LAST:event_StopButtonActionPerformed

    private void pauseButtonActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_pauseButtonActionPerformed
        // app.pauseOrContinueApp();
        if (simulation.isPaused()) {
            simulation.resumeSimulation();
        } else {
            simulation.pauseSimulation();
        }

    }//GEN-LAST:event_pauseButtonActionPerformed

    private void speedSliderStateChanged(javax.swing.event.ChangeEvent evt) {//GEN-FIRST:event_speedSliderStateChanged
        SpeedLabel.setText("Simulation speed: " + speedSlider.getValue());
        if (simulation != null) {
            simulation.setSpeedChange(speedSlider.getValue());
        }
    }//GEN-LAST:event_speedSliderStateChanged

    private void startSimulationActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_startSimulationActionPerformed
        runType = runType.SIMULATION;
        startThreads();

    }//GEN-LAST:event_startSimulationActionPerformed

    private void startSimulation2ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_startSimulation2ActionPerformed
        runType = runType.DEPENDENCY_2;
        values.clear();
        offset = 10;
        startThreads();
    }//GEN-LAST:event_startSimulation2ActionPerformed

    private void startSimulation3ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_startSimulation3ActionPerformed
        runType = runType.DEPENDENCY_1;
        values.clear();
        offset = 1;
        startThreads();
    }//GEN-LAST:event_startSimulation3ActionPerformed

    private void countOfEmployees1BoxActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_countOfEmployees1BoxActionPerformed
        // TODO add your handling code here:
    }//GEN-LAST:event_countOfEmployees1BoxActionPerformed

    private void checkboxAnimationActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_checkboxAnimationActionPerformed
        // TODO add your handling code here:
    }//GEN-LAST:event_checkboxAnimationActionPerformed

    public void setSimulation(MySimulation simulation) {
        this.simulation = simulation;
    }

    /**
     * @param args the command line arguments
     */
    public static void main(String args[]) {
        /* Set the Nimbus look and feel */
        //<editor-fold defaultstate="collapsed" desc=" Look and feel setting code (optional) ">
        /* If Nimbus (introduced in Java SE 6) is not available, stay with the default look and feel.
         * For details see http://download.oracle.com/javase/tutorial/uiswing/lookandfeel/plaf.html 
         */
        try {
            for (javax.swing.UIManager.LookAndFeelInfo info : javax.swing.UIManager.getInstalledLookAndFeels()) {
                if ("Nimbus".equals(info.getName())) {
                    javax.swing.UIManager.setLookAndFeel(info.getClassName());
                    break;
                }
            }
        } catch (ClassNotFoundException ex) {
            java.util.logging.Logger.getLogger(Diss_sp_3.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
        } catch (InstantiationException ex) {
            java.util.logging.Logger.getLogger(Diss_sp_3.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
        } catch (IllegalAccessException ex) {
            java.util.logging.Logger.getLogger(Diss_sp_3.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
        } catch (javax.swing.UnsupportedLookAndFeelException ex) {
            java.util.logging.Logger.getLogger(Diss_sp_3.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
        }
        //</editor-fold>
        //</editor-fold>
        //</editor-fold>
        //</editor-fold>

        /* Create and display the form */
        java.awt.EventQueue.invokeLater(new Runnable() {
            public void run() {
                new Diss_sp_3().setVisible(true);

            }
        });
    }

    /*
        START NEW SIMULATION
     */
    public void startSimulation() throws IOException, Exception {

        simulation = new MySimulation();
        simulation.setType(runType);
        simulation.setCountOfEmployeeType1(Integer.valueOf(countOfEmployees1Box.getText()));
        simulation.setCountOfEmployeeType2WithCertificate1(Integer.valueOf(countOfEmployees2Box.getText()));
        simulation.setCountOfEmployeeType2WithCertificate2(Integer.valueOf(countOfEmployees2Box2.getText()));
        int countOfReplication = Integer.valueOf(EditCountOfReplications.getText());
        simulation.registerDelegate(this);

        if (runType == RunType.REPLICATIONS) {
            simulation.setValidationRun(checkboxValidation.isSelected());
//
//            for (int i = 0; i < 1000; i++) {
//                simulation = new MySimulation(i);
//                simulation.setType(runType);
//                simulation.setCountOfEmployeeType1(Integer.valueOf(countOfEmployees1Box.getText()));
//                simulation.setCountOfEmployeeType2WithCertificate1(Integer.valueOf(countOfEmployees2Box.getText()));
//                simulation.setCountOfEmployeeType2WithCertificate2(Integer.valueOf(countOfEmployees2Box2.getText()));
            simulation.setMaxSimSpeed();
//                simulation.setSpeedChange(speedSlider.getValue());
            simulation.simulate(countOfReplication, 480);
            //    System.out.println("" + i + " | " + simulation.getAvgTimeInSystem().mean());
            // }

            //app.replicate(this, countOfReplication, Integer.valueOf(countOfEmployees1Box.getText()), Integer.valueOf(countOfEmployees2Box.getText()), RunType.REPLICATIONS);
        } else if (runType == RunType.SIMULATION) {

            simulation.setValidationRun(checkboxValidation.isSelected());

            simulation.setSpeedChange(speedSlider.getValue());
            if (checkboxAnimation.isSelected()) {

                FormAnimator f = new FormAnimator(this);
                f.setVisible(true);
                this.animator = new Animator(simulation, f.getCanvas1());
                simulation.setAnimator(animator);
            }
            simulation.simulate(1, 480);
        } else if (runType == RunType.DEPENDENCY_1) {
            managerDep = new ManagerDependencies();
            managerDep.findDependencyOnEmp1(this, Integer.valueOf(countOfEmployees2Box1.getText()), Integer.valueOf(countOfEmployees2Box3.getText()), checkboxValidation.isSelected(), countOfReplication);
        } else if (runType == RunType.DEPENDENCY_2) {
            managerDep = new ManagerDependencies();
            managerDep.findDependencyOnEmp2(this, Integer.valueOf(countOfEmployees1Box1.getText()), countOfReplication, checkboxValidation.isSelected());
        }

    }

    private void refreshCharts() throws IOException {
        panelGraph2.repaint();
    }

    private void startThreads() {
        if ((threadLogic == null && threadGraph == null) || (!threadLogic.isAlive() && !threadGraph.isAlive())) {

            threadLogic = new ExtraThread(this);
            threadLogic.start();
            threadGraph = new ChartThread(this);
            threadGraph.start();
        }
    }

    private void createLineChart(String name, String seriesName) throws IOException {
        panelGraph2.removeAll();
        panelGraph2.repaint();
        series = new XYSeries(seriesName);
        this.panelGraph2.repaint();
        database = new XYSeriesCollection();
        chart = ChartFactory.createXYLineChart(name, "count of employees", seriesName, database, PlotOrientation.VERTICAL, true, true, false);
        chartPanel = new ChartPanel(chart);
        XYPlot plot = chart.getXYPlot();
        plot.setBackgroundPaint(Color.white);
        ((NumberAxis) plot.getRangeAxis()).setAutoRangeIncludesZero(false);
        this.panelGraph2.setLayout(new java.awt.BorderLayout());
        this.panelGraph2.add(chartPanel);
        this.panelGraph2.validate();
    }

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JTextField EditCountOfReplications;
    private javax.swing.JLabel SpeedLabel;
    private javax.swing.JButton StartButton;
    private javax.swing.JButton StopButton;
    private javax.swing.JCheckBox checkboxAnimation;
    private javax.swing.JCheckBox checkboxValidation;
    private javax.swing.JTextField countOfEmployees1Box;
    private javax.swing.JTextField countOfEmployees1Box1;
    private javax.swing.JTextField countOfEmployees2Box;
    private javax.swing.JTextField countOfEmployees2Box1;
    private javax.swing.JTextField countOfEmployees2Box2;
    private javax.swing.JTextField countOfEmployees2Box3;
    private javax.swing.JLabel jLabel1;
    private javax.swing.JLabel jLabel10;
    private javax.swing.JLabel jLabel11;
    private javax.swing.JLabel jLabel12;
    private javax.swing.JLabel jLabel13;
    private javax.swing.JLabel jLabel14;
    private javax.swing.JLabel jLabel15;
    private javax.swing.JLabel jLabel16;
    private javax.swing.JLabel jLabel17;
    private javax.swing.JLabel jLabel18;
    private javax.swing.JLabel jLabel19;
    private javax.swing.JLabel jLabel2;
    private javax.swing.JLabel jLabel20;
    private javax.swing.JLabel jLabel21;
    private javax.swing.JLabel jLabel22;
    private javax.swing.JLabel jLabel23;
    private javax.swing.JLabel jLabel24;
    private javax.swing.JLabel jLabel25;
    private javax.swing.JLabel jLabel26;
    private javax.swing.JLabel jLabel27;
    private javax.swing.JLabel jLabel3;
    private javax.swing.JLabel jLabel4;
    private javax.swing.JLabel jLabel5;
    private javax.swing.JLabel jLabel6;
    private javax.swing.JLabel jLabel7;
    private javax.swing.JLabel jLabel8;
    private javax.swing.JLabel jLabel9;
    private javax.swing.JLabel jLabelActualQueue;
    private javax.swing.JLabel jLabelCountOfParkingPlaces;
    private javax.swing.JLabel jLabelCountOfType1Employees;
    private javax.swing.JLabel jLabelCountOfType2Employees;
    private javax.swing.JLabel jLabelCountReplication;
    private javax.swing.JLabel jLabelParking;
    private javax.swing.JLabel jLabelTime;
    private javax.swing.JPanel jPanel1;
    private javax.swing.JScrollPane jScrollPane1;
    private javax.swing.JScrollPane jScrollPane2;
    private javax.swing.JScrollPane jScrollPane3;
    private javax.swing.JScrollPane jScrollPane4;
    private javax.swing.JTable jTable1;
    private javax.swing.JTable jTable2;
    private javax.swing.JTable jTable3;
    private javax.swing.JTable jTable4;
    private javax.swing.JPanel panelGraph2;
    private javax.swing.JButton pauseButton;
    private javax.swing.JSlider speedSlider;
    private javax.swing.JButton startSimulation;
    private javax.swing.JButton startSimulation2;
    private javax.swing.JButton startSimulation3;
    // End of variables declaration//GEN-END:variables

    
    public void setScale(int scale){
        this.animator.setScale(scale);
    }
    
    public void startDraw() throws InterruptedException, IOException {
        //

        cleanLabels();
        database.addSeries(series);
        try {
            if (RunType.DEPENDENCY_2 == runType) {
                panelGraph2.setVisible(true);
                cleanLabels();
                createLineChart("Average time in system and dependency with Employees (type 2)", "Average time in system");
            } else if (RunType.DEPENDENCY_1 == runType) {
                panelGraph2.setVisible(true);
                cleanLabels();
                createLineChart("Average queue length and dependency with Employees (type 1)", "Average queue length");
            } else {
                createLineChart("", "");
                panelGraph2.setVisible(false);
            }
        } catch (IOException ex) {
            Logger.getLogger(Diss_sp_3.class.getName()).log(Level.SEVERE, null, ex);
        }

        if (RunType.SIMULATION == runType) {
            //hideLabels();
            initializeTables();
        }



        while (true) {
            if (refreshGuiChanges) {
                refreshGuiChanges = false;

                if (runType == RunType.SIMULATION) {
                    updateSimStats();
                } else if (runType == RunType.DEPENDENCY_1) {
                    updateCharts();
                } else if (runType == RunType.DEPENDENCY_2) {
                    updateCharts();
                }

            }
            if (!threadLogic.isAlive()) {
                if (runType == RunType.SIMULATION) {

                    updateSimStats();
                } else if (runType == RunType.REPLICATIONS) {
                    updateReplicationStats();
                } else {
                    updateCharts();
                }

                break;
            }
        }

    }

    private void updateSimStats() throws IOException, InterruptedException {

        jLabel2.setText("Average waiting time for vehicle take-over: " + simulation.agentReception().getWaitingTimeStat().mean());
        jLabel3.setText("Average time in system: " + simulation.agentEnviroment().getAverageTimeInSystem().mean());
        jLabel6.setText("Average free employees(type 1): " + simulation.agentReception().getEmployee().lengthStatistic().mean());
        jLabel7.setText("Average free employees(type 2) with C1: " + simulation.agentMechanics().getEmployeeWithCertificate1().lengthStatistic().mean());
        jLabel10.setText("Average free employees(type 2) with C2: " + simulation.agentMechanics().getEmployeeWithCertificate2().lengthStatistic().mean());
        jLabelTime.setText("Time: " + simulation.getTime() + " (" + simulation.currentTime() + ")");

        jLabelCountOfType1Employees.setText("Actually working of employees(type 1): " + simulation.agentReception().getCountOfWorking());
        jLabelCountOfType2Employees.setText("Actually working of employees(type 2): " + (simulation.agentMechanics().getCountOfWorkingC1() + simulation.agentMechanics().getCountOfWorkingC2()) + " (With C2 - " + simulation.agentMechanics().getCountOfWorkingC2() + ")");
        jLabelCountOfParkingPlaces.setText("Count of occupied parking places: " + simulation.agentParking().getQueue().size());
        jLabelActualQueue.setText("Actual queue length(type 1): " + simulation.agentReception().getQueueTakeOver().size());
        jLabelParking.setText("Actual queue length(type 2): " + simulation.agentReception().getQueuePaying().size());
        jLabel9.setText("Average count of customers: " + simulation.agentEnviroment().getCustomers().lengthStatistic().mean());

        jLabel27.setText("Average queue of customers: " + simulation.agentReception().getQueueTakeOver().lengthStatistic().mean());
        DefaultTableModel model = (DefaultTableModel) jTable1.getModel();
        //   jLabel16.setText("Average queue length: " + simulation.getAvgQueueLength().mean());

        // UPDATE EMPLOYEES TYPE 2
        ArrayList<CustomerObject> emp = simulation.agentMechanics().getGuiEmployers();
        for (int j = 0; j < simulation.agentMechanics().getTotalCountOfEmployees(); j++) {
            CustomerObject customer = emp.get(j);
            if (customer == null) {
                if (!model.getValueAt(j, 1).equals(FREE)) {
                    model.setValueAt(FREE, j, 1);
                    model.setValueAt(DASH, j, 2);
                }
            } else {
                if (customer.isInspectionRewrite() == true) {
                    model.setValueAt("Customer " + customer.getCount(), j, 1);
                    model.setValueAt(customer.getNameVehicle(), j, 2);
                } else if (customer.isPause()) {
                    model.setValueAt(PAUSE, j, 1);
                    model.setValueAt(DASH, j, 2);
                }

            }
        }

        // UPDATE EMPLOYEES TYPE 1
        model = (DefaultTableModel) jTable2.getModel();

        emp = simulation.agentReception().getGuiEmployers();
        for (int j = 0; j < simulation.agentReception().getTotalCountOfEmployees(); j++) {
            CustomerObject customer = emp.get(j);
            if (customer == null) {
                if (!model.getValueAt(j, 1).equals(FREE)) {
                    model.setValueAt(FREE, j, 1);
                    model.setValueAt(DASH, j, 2);
                }
            } else {
                if (!customer.isPause()) {
                    model.setValueAt("Customer " + customer.getCount(), j, 1);

                    if (customer.isPaymentRewrite() == true) {
                        model.setValueAt("PAYMENT", j, 2);
                    } else if (customer.isTakeOverRewrite() == true) {
                        model.setValueAt("TAKE-OVER VEHICLE", j, 2);
                    }
                } else {
                    model.setValueAt(PAUSE, j, 1);
                    model.setValueAt(DASH, j, 2);
                }
            }
        }
        // UPDATE Parking
        model = (DefaultTableModel) jTable3.getModel();
        emp = simulation.agentParking().getParkingPlaces();
        for (int j = 0; j < simulation.agentParking().getTotalCountOfParkingPlaces(); j++) {
            CustomerObject customer = emp.get(j);
            if (customer == null) {
                if (!model.getValueAt(j, 1).equals(FREE)) {
                    model.setValueAt(FREE, j, 1);
                    model.setValueAt(DASH, j, 2);
                }
            } else {
                if (customer.isParkingRewrite() == true) {
                    model.setValueAt("Customer " + customer.getCount(), j, 1);
                    model.setValueAt(customer.getNameVehicle(), j, 2);
                }
            }
        }
//
//        // UPDATE queue
        model = (DefaultTableModel) jTable4.getModel();
        Queue<MessageForm> empQ = simulation.agentReception().getQueuePayingGui();
        ConcurrentLinkedQueue<MessageForm> customers = new ConcurrentLinkedQueue<>(empQ);
        Queue<MessageForm> e = simulation.agentReception().getQueueTakeOverGui();
        customers.addAll(e);
        int length = customers.size();
//ArrayList<CustomerObject> p = simulation.getParkingNew();
        // emp.addAll(p);
        for (int j = 0; j < length; j++) {
            CustomerObject customer = ((MyMessage) customers.poll()).getCustomer();

            if (customer == null) {
                if (!model.getValueAt(j, 1).equals(FREE)) {
                    model.setValueAt(FREE, j, 1);
                }
            } else {
                if (j < model.getRowCount()) {
                    model.setValueAt("Customer " + customer.getCount(), j, 1);
                    if (customer.isPark() == true) {
                        model.setValueAt("PARK", j, 2);
                    } else if (customer.isWaitingForPayment() == true) {
                        model.setValueAt("PAYMENT", j, 2);
                    } else {
                        model.setValueAt("TAKE-OVER VEHICLE", j, 2);
                    }
                } else {
                    if (customer.isPark() == true) {
                        model.addRow(new Object[]{"" + (j + 1), "Customer " + (j + 1), "PARK"});

                    } else if (customer.isWaitingForPayment() == true) {
                        model.addRow(new Object[]{"" + (j + 1), "Customer " + (j + 1), "PAYMENT"});
                    } else {
                        model.addRow(new Object[]{"" + (j + 1), "Customer " + (j + 1), "TAKE-OVER VEHICLE"});
                    }
                }
            }

        }
        if (model.getRowCount() != length) {
            model.setRowCount(length);
        }

    }

    private void updateReplicationStats() {
        cleanLabels();

        jLabel12.setText("Average waiting time: " + simulation.getAvgWaitingTime().mean());
        jLabel10.setText("Average time in system: " + simulation.getAvgTimeInSystem().mean());
        jLabel14.setText("Average free employees(type 1): " + simulation.getAvgFreeEmp1().mean());
        jLabel13.setText("Average free employees(type 2): " + simulation.getAvgFreeEmp2().mean());
        jLabel18.setText("Average free employees(type 2) with C2: " + simulation.getAvgFreeEmp2WithC2().mean());
        jLabelCountReplication.setText("Replication: " + (simulation.currentReplication() + 1));
        jLabel8.setText("Average count of vehicles in system: " + simulation.getAvgCOuntOfVehicles().mean());
        if (simulation.currentReplication() >= 29) {
            jLabel15.setText("Time in system interval confidence: " + simulation.getAvgTimeInSystem().confidenceInterval_90()[0] + " - " + simulation.getAvgTimeInSystem().confidenceInterval_90()[1]);
            jLabel17.setText("Average count of customers interval confidence: " + simulation.getAvgCountOfCustomers().confidenceInterval_95()[0] + " - " + simulation.getAvgCountOfCustomers().confidenceInterval_95()[1]);
        }

        jLabel16.setText("Average count of customers: " + simulation.getAvgCountOfCustomers().mean());
        jLabel7.setText("Average queue length: " + simulation.getAvgQueueLength().mean());
    }

    public void cleanLabels() {
        jLabel11.setText("");

        if (runType == RunType.REPLICATIONS || runType == RunType.SIMULATION) {
            if (runType == RunType.REPLICATIONS) {
                jLabel11.setText("Replications");
                jPanel1.setVisible(false);

            } else {
                jLabel11.setText("Simulation");
                jPanel1.setVisible(true);
            }
            jScrollPane1.setViewportView(jTable1);
            jScrollPane2.setViewportView(jTable2);
            jScrollPane3.setViewportView(jTable3);
            jScrollPane4.setViewportView(jTable4);

        } else {
            jPanel1.setVisible(false);

        }
        jLabel2.setText("");
        jLabel3.setText("");
        jLabel6.setText("");
        jLabel7.setText("");
        jLabelTime.setText("");
        jLabelCountOfType1Employees.setText("");
        jLabelCountOfType2Employees.setText("");
        jLabelCountOfParkingPlaces.setText("");
        jLabelActualQueue.setText("");
        jLabelParking.setText("");
        jLabel9.setText("");
        jLabelCountReplication.setText("");
        jLabel12.setText("");
        jLabel8.setText("");
        jLabel14.setText("");
        jLabel13.setText("");
        jLabelCountReplication.setText("");
        jLabel8.setText("");
        jLabel15.setText("");
        jLabel17.setText("");
        jLabel18.setText("");
        jLabel16.setText("");
        jLabel10.setText("");
        jLabel27.setText("");
    }

    private void initializeTables() {
        simulation = (MySimulation) simulation;

        DefaultTableCellRenderer centerRenderer = new DefaultTableCellRenderer();
        centerRenderer.setHorizontalAlignment(JLabel.CENTER);

        jTable1.getColumnModel().getColumn(0).setCellRenderer(centerRenderer);
        jTable1.getColumnModel().getColumn(1).setCellRenderer(centerRenderer);
        jTable1.getColumnModel().getColumn(2).setCellRenderer(centerRenderer);
        jTable2.getColumnModel().getColumn(0).setCellRenderer(centerRenderer);
        jTable2.getColumnModel().getColumn(1).setCellRenderer(centerRenderer);
        jTable2.getColumnModel().getColumn(2).setCellRenderer(centerRenderer);
        jTable3.getColumnModel().getColumn(0).setCellRenderer(centerRenderer);
        jTable3.getColumnModel().getColumn(1).setCellRenderer(centerRenderer);
        jTable3.getColumnModel().getColumn(2).setCellRenderer(centerRenderer);
        jTable4.getColumnModel().getColumn(0).setCellRenderer(centerRenderer);
        jTable4.getColumnModel().getColumn(1).setCellRenderer(centerRenderer);
        jTable4.getColumnModel().getColumn(2).setCellRenderer(centerRenderer);

        updateTableHeader(jTable1);
        updateTableHeader(jTable2);
        updateTableHeader(jTable3);
        updateTableHeader(jTable4);

        DefaultTableModel model = (DefaultTableModel) jTable1.getModel();
        model.setRowCount(0);
        for (int j = 0; j < simulation.agentMechanics().getTotalCountOfEmployees(); j++) {
            if (j < simulation.agentMechanics().getTotalCountOfEmployeesWithCertificate1()) {
                model.addRow(new Object[]{"Employer " + (j + 1), FREE, DASH});
            } else {
                model.addRow(new Object[]{"Employer " + (j + 1) + " (C2)", FREE, DASH});
            }

        }

        model = (DefaultTableModel) jTable2.getModel();
        model.setRowCount(0);
        for (int j = 0; j < simulation.agentReception().getTotalCountOfEmployees(); j++) {
            model.addRow(new Object[]{"Employer " + (j + 1), FREE, DASH});
        }

        model = (DefaultTableModel) jTable3.getModel();
        model.setRowCount(0);
        for (int j = 0; j < simulation.agentParking().getTotalCountOfParkingPlaces(); j++) {
            model.addRow(new Object[]{"Place " + (j + 1), FREE, DASH, DASH});
        }

        model = (DefaultTableModel) jTable4.getModel();
        model.setRowCount(0);

    }

    private void updateTableHeader(JTable table) {
        ((DefaultTableCellRenderer) table.getTableHeader().getDefaultRenderer())
                .setHorizontalAlignment(JLabel.CENTER);
    }

    private void updateCharts() throws IOException {

        for (int i = series.getItemCount(); i < values.size(); i++) {
            series.add(i + offset, values.get(i));
        }
        XYDataset dataset = new XYSeriesCollection(series);
        chart.getXYPlot().setDataset(dataset);
        refreshCharts();
    }

    @Override
    public void simStateChanged(Simulation smltn, SimState ss) {

    }

    //TODO DEPENDENCIES
    @Override
    public void refresh(Simulation smltn) {
        simulation = (MySimulation) smltn;
        refreshGuiChanges = true;

        if (runType == RunType.DEPENDENCY_1) {
            values.add(simulation.getAvgQueueLength().mean());
        } else if (runType == RunType.DEPENDENCY_2) {
            values.add(simulation.getAvgTimeInSystem().mean());
        }
    }

   

}
